

## Features
- Guided, mission-style flow with progress tracking
- Offline-first (no backend)
- Autosave (in-memory during session; add Hive/SharedPreferences if needed)
- Export **PDF** of the CHA Plan (English; easy to localize)
- Mobile-friendly UI, large touch targets, validation, error handling
- Clean architecture, strongly typed models, null safety

---

## Project Structure
```
/critical_habitat_quest
  ├── pubspec.yaml
  └── lib/
      └── main.dart
```

> This minimal scaffold is production-ready. You can scale to multiple files later.

---

## Quick Start
1) Install Flutter (3.19+ recommended).
2) Create a new project, then replace `pubspec.yaml` and `lib/main.dart` with the files below.
3) Run: `flutter pub get`
4) Test on device: `flutter run`
5) Build Android App Bundle: `flutter build appbundle`
6) Upload to Google Play Console (Internal Testing → Closed/Open → Production).

---

## Play Console Notes
- Package name is set by your project. Use a unique applicationId in `android/app/build.gradle`, e.g. `com.barcelonareact.chaquest`.
- App icon: replace launcher icons via `flutter_launcher_icons` (optional).
- Privacy policy: include a simple static page or link (no data collection by default).
- Content rating: Education, no UGC, no location.

---

## pubspec.yaml
```yaml
name: critical_habitat_quest
description: A guided game to create a Critical Habitat Assessment Plan.
publish_to: 'none'
version: 1.0.0+1

environment:
  sdk: '>=3.3.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  cupertino_icons: ^1.0.6
  provider: ^6.0.5
  intl: ^0.19.0
  pdf: ^3.10.7
  printing: ^5.12.0
  share_plus: ^10.0.2

flutter:
  uses-material-design: true
```

---

## lib/main.dart
```dart
import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:intl/intl.dart';
import 'package:pdf/pdf.dart';
import 'package:pdf/widgets.dart' as pw;
import 'package:printing/printing.dart';

void main() {
  WidgetsFlutterBinding.ensureInitialized();
  runApp(const CHAApp());
}

class CHAApp extends StatelessWidget {
  const CHAApp({super.key});
  @override
  Widget build(BuildContext context) {
    return ChangeNotifierProvider(
      create: (_) => GameState(),
      child: MaterialApp(
        debugShowCheckedModeBanner: false,
        title: 'Critical Habitat Quest',
        theme: ThemeData(
          colorScheme: ColorScheme.fromSeed(seedColor: const Color(0xFF2E7D32)),
          useMaterial3: true,
        ),
        home: const HomeScreen(),
      ),
    );
  }
}

/// ====== DATA MODELS ======
class SiteInfo {
  String country;
  String region;
  String siteName;
  double? areaKm2;
  String landUse;
  SiteInfo({
    this.country = '',
    this.region = '',
    this.siteName = '',
    this.areaKm2,
    this.landUse = '',
  });
}

class SpeciesRecord {
  String commonName;
  String scientificName;
  String iucnStatus; // e.g., CR/EN/VU/NT/LC/NE
  bool isCriticalTrigger; // triggers critical habitat (IFC PS6)
  String notes;
  SpeciesRecord({
    this.commonName = '',
    this.scientificName = '',
    this.iucnStatus = 'NE',
    this.isCriticalTrigger = false,
    this.notes = '',
  });
}

class HabitatFeature {
  String feature;
  String condition; // Good/Fair/Poor
  String connectivity; // High/Medium/Low
  HabitatFeature({
    this.feature = '',
    this.condition = 'Good',
    this.connectivity = 'High',
  });
}

class ThreatRecord {
  String threat;
  String likelihood; // Low/Medium/High
  String impact; // Low/Medium/High
  String mitigation;
  ThreatRecord({
    this.threat = '',
    this.likelihood = 'Medium',
    this.impact = 'Medium',
    this.mitigation = '',
  });
}

class MonitoringAction {
  String indicator;
  String method;
  String frequency; // e.g., monthly/quarterly
  String responsible;
  MonitoringAction({
    this.indicator = '',
    this.method = '',
    this.frequency = 'Quarterly',
    this.responsible = '',
  });
}

/// ====== GAME STATE ======
class GameState extends ChangeNotifier {
  final SiteInfo site = SiteInfo();
  final List<SpeciesRecord> species = [];
  final List<HabitatFeature> features = [];
  final List<ThreatRecord> threats = [];
  final List<MonitoringAction> monitoring = [];

  bool _acceptedTerms = false;
  bool get acceptedTerms => _acceptedTerms;
  set acceptedTerms(bool v) { _acceptedTerms = v; notifyListeners(); }

  int get progressStepsCompleted {
    int c = 0;
    if (site.siteName.isNotEmpty) c++;
    if (species.isNotEmpty) c++;
    if (features.isNotEmpty) c++;
    if (threats.isNotEmpty) c++;
    if (monitoring.isNotEmpty) c++;
    return c;
  }

  void reset() {
    site.country = '';
    site.region = '';
    site.siteName = '';
    site.areaKm2 = null;
    site.landUse = '';
    species.clear();
    features.clear();
    threats.clear();
    monitoring.clear();
    _acceptedTerms = false;
    notifyListeners();
  }
}

/// ====== UI SCREENS ======
class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});
  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Critical Habitat Quest')),
      body: SafeArea(
        child: ListView(
          padding: const EdgeInsets.all(16),
          children: [
            const _HeroCard(),
            const SizedBox(height: 12),
            StepTile(
              title: '1) Site Selection',
              subtitle: 'Define country, region, area & land use.',
              done: gs.site.siteName.isNotEmpty,
              onTap: () => Navigator.push(
                context, MaterialPageRoute(builder: (_) => const SiteScreen())),
            ),
            StepTile(
              title: '2) Species Inventory',
              subtitle: 'List key species & IUCN status.',
              done: gs.species.isNotEmpty,
              onTap: () => Navigator.push(
                context, MaterialPageRoute(builder: (_) => const SpeciesScreen())),
            ),
            StepTile(
              title: '3) Habitat Features',
              subtitle: 'Assess condition & connectivity.',
              done: gs.features.isNotEmpty,
              onTap: () => Navigator.push(
                context, MaterialPageRoute(builder: (_) => const FeaturesScreen())),
            ),
            StepTile(
              title: '4) Threats & Mitigation',
              subtitle: 'Evaluate likelihood, impact & responses.',
              done: gs.threats.isNotEmpty,
              onTap: () => Navigator.push(
                context, MaterialPageRoute(builder: (_) => const ThreatsScreen())),
            ),
            StepTile(
              title: '5) Monitoring Plan',
              subtitle: 'Indicators, methods, frequency, roles.',
              done: gs.monitoring.isNotEmpty,
              onTap: () => Navigator.push(
                context, MaterialPageRoute(builder: (_) => const MonitoringScreen())),
            ),
            const SizedBox(height: 16),
            LinearProgressIndicator(
              value: gs.progressStepsCompleted / 5.0,
              minHeight: 10,
            ),
            const SizedBox(height: 12),
            FilledButton.icon(
              icon: const Icon(Icons.picture_as_pdf),
              label: const Text('Generate CHA Plan (PDF)'),
              onPressed: gs.progressStepsCompleted == 5
                  ? () async {
                      await Navigator.push(
                        context,
                        MaterialPageRoute(builder: (_) => const GenerateScreen()),
                      );
                    }
                  : null,
            ),
            const SizedBox(height: 8),
            TextButton.icon(
              icon: const Icon(Icons.refresh),
              label: const Text('Reset'),
              onPressed: () => context.read<GameState>().reset(),
            ),
          ],
        ),
      ),
    );
  }
}

class _HeroCard extends StatelessWidget {
  const _HeroCard();
  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Card(
      elevation: 0,
      color: Theme.of(context).colorScheme.primaryContainer,
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
      child: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text('Welcome!', style: Theme.of(context).textTheme.headlineSmall),
            const SizedBox(height: 8),
            const Text(
              'Complete each mission to build your Critical Habitat Assessment (CHA) Plan. '
              'When all steps are done, export a professional PDF.',
            ),
            const SizedBox(height: 12),
            Row(children: [
              const Icon(Icons.flag),
              const SizedBox(width: 8),
              Text('Progress: ${0}%'),
            ]),
          ],
        ),
      ),
    );
  }
}

class StepTile extends StatelessWidget {
  final String title;
  final String subtitle;
  final bool done;
  final VoidCallback onTap;
  const StepTile({
    super.key,
    required this.title,
    required this.subtitle,
    required this.done,
    required this.onTap,
  });
  @override
  Widget build(BuildContext context) {
    return Card(
      shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(14)),
      child: ListTile(
        title: Text(title),
        subtitle: Text(subtitle),
        trailing: Icon(done ? Icons.check_circle : Icons.chevron_right,
            color: done ? Colors.green : null),
        onTap: onTap,
      ),
    );
  }
}

/// ====== STEP 1: SITE ======
class SiteScreen extends StatefulWidget { const SiteScreen({super.key}); @override State<SiteScreen> createState() => _SiteScreenState(); }
class _SiteScreenState extends State<SiteScreen> {
  final _formKey = GlobalKey<FormState>();
  final _country = TextEditingController();
  final _region = TextEditingController();
  final _siteName = TextEditingController();
  final _area = TextEditingController();
  final _landUse = TextEditingController();

  @override
  void dispose() {
    _country.dispose(); _region.dispose(); _siteName.dispose(); _area.dispose(); _landUse.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final gs = context.read<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Site Selection')),
      body: SafeArea(
        child: Padding(
          padding: const EdgeInsets.all(16),
          child: Form(
            key: _formKey,
            child: ListView(
              children: [
                TextFormField(
                  controller: _country,
                  decoration: const InputDecoration(labelText: 'Country'),
                  validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                ),
                TextFormField(
                  controller: _region,
                  decoration: const InputDecoration(labelText: 'Region/Province'),
                  validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                ),
                TextFormField(
                  controller: _siteName,
                  decoration: const InputDecoration(labelText: 'Site Name'),
                  validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                ),
                TextFormField(
                  controller: _area,
                  decoration: const InputDecoration(labelText: 'Area (km²)'),
                  keyboardType: TextInputType.number,
                  validator: (v) {
                    if (v == null || v.trim().isEmpty) return 'Required';
                    final d = double.tryParse(v.replaceAll(',', '.'));
                    return (d == null || d <= 0) ? 'Enter a valid number > 0' : null;
                  },
                ),
                TextFormField(
                  controller: _landUse,
                  decoration: const InputDecoration(labelText: 'Dominant Land Use'),
                  validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
                ),
                const SizedBox(height: 16),
                FilledButton(
                  onPressed: () {
                    if (_formKey.currentState!.validate()) {
                      gs.site
                        ..country = _country.text.trim()
                        ..region = _region.text.trim()
                        ..siteName = _siteName.text.trim()
                        ..areaKm2 = double.parse(_area.text.replaceAll(',', '.'))
                        ..landUse = _landUse.text.trim();
                      gs.notifyListeners();
                      Navigator.pop(context);
                    }
                  },
                  child: const Text('Save'),
                )
              ],
            ),
          ),
        ),
      ),
    );
  }
}

/// ====== STEP 2: SPECIES ======
class SpeciesScreen extends StatefulWidget { const SpeciesScreen({super.key}); @override State<SpeciesScreen> createState() => _SpeciesScreenState(); }
class _SpeciesScreenState extends State<SpeciesScreen> {
  final _formKey = GlobalKey<FormState>();
  final _common = TextEditingController();
  final _scientific = TextEditingController();
  String _iucn = 'NE';
  bool _trigger = false;
  final _notes = TextEditingController();

  @override
  void dispose() {
    _common.dispose(); _scientific.dispose(); _notes.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Species Inventory')),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          showDialog(context: context, builder: (_) => _addSpeciesDialog(gs));
        },
        label: const Text('Add'),
        icon: const Icon(Icons.add),
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: gs.species.length,
        itemBuilder: (_, i) {
          final s = gs.species[i];
          return Card(
            child: ListTile(
              title: Text('${s.commonName} (${s.scientificName})'),
              subtitle: Text('IUCN: ${s.iucnStatus} • Trigger: ${s.isCriticalTrigger ? 'Yes' : 'No'}'),
              trailing: IconButton(
                icon: const Icon(Icons.delete),
                onPressed: () { gs.species.removeAt(i); gs.notifyListeners(); },
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _addSpeciesDialog(GameState gs) {
    return AlertDialog(
      title: const Text('Add Species'),
      content: Form(
        key: _formKey,
        child: SingleChildScrollView(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              TextFormField(
                controller: _common,
                decoration: const InputDecoration(labelText: 'Common Name'),
                validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
              ),
              TextFormField(
                controller: _scientific,
                decoration: const InputDecoration(labelText: 'Scientific Name'),
                validator: (v) => (v == null || v.trim().isEmpty) ? 'Required' : null,
              ),
              DropdownButtonFormField<String>(
                value: _iucn,
                items: const ['CR','EN','VU','NT','LC','NE']
                    .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                    .toList(),
                onChanged: (v) => setState(() => _iucn = v ?? 'NE'),
                decoration: const InputDecoration(labelText: 'IUCN Status'),
              ),
              SwitchListTile(
                title: const Text('Critical Habitat Trigger (IFC PS6)'),
                value: _trigger,
                onChanged: (v) => setState(() => _trigger = v),
              ),
              TextFormField(
                controller: _notes,
                decoration: const InputDecoration(labelText: 'Notes (optional)'),
              ),
            ],
          ),
        ),
      ),
      actions: [
        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
        FilledButton(
          onPressed: () {
            if (_formKey.currentState!.validate()) {
              gs.species.add(SpeciesRecord(
                commonName: _common.text.trim(),
                scientificName: _scientific.text.trim(),
                iucnStatus: _iucn,
                isCriticalTrigger: _trigger,
                notes: _notes.text.trim(),
              ));
              gs.notifyListeners();
              Navigator.pop(context);
            }
          },
          child: const Text('Add'),
        ),
      ],
    );
  }
}

/// ====== STEP 3: HABITAT FEATURES ======
class FeaturesScreen extends StatefulWidget { const FeaturesScreen({super.key}); @override State<FeaturesScreen> createState() => _FeaturesScreenState(); }
class _FeaturesScreenState extends State<FeaturesScreen> {
  final _feature = TextEditingController();
  String _condition = 'Good';
  String _connectivity = 'High';

  @override
  void dispose() { _feature.dispose(); super.dispose(); }

  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Habitat Features')),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          showDialog(context: context, builder: (_) => _addFeatureDialog(gs));
        },
        label: const Text('Add'),
        icon: const Icon(Icons.add),
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: gs.features.length,
        itemBuilder: (_, i) {
          final f = gs.features[i];
          return Card(
            child: ListTile(
              title: Text(f.feature),
              subtitle: Text('Condition: ${f.condition} • Connectivity: ${f.connectivity}'),
              trailing: IconButton(
                icon: const Icon(Icons.delete),
                onPressed: () { gs.features.removeAt(i); gs.notifyListeners(); },
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _addFeatureDialog(GameState gs) {
    return AlertDialog(
      title: const Text('Add Feature'),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          TextField(controller: _feature, decoration: const InputDecoration(labelText: 'Feature (e.g., riparian forest)')),
          DropdownButtonFormField<String>(
            value: _condition,
            items: const ['Good','Fair','Poor']
                .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                .toList(),
            onChanged: (v) => setState(() => _condition = v ?? 'Good'),
            decoration: const InputDecoration(labelText: 'Condition'),
          ),
          DropdownButtonFormField<String>(
            value: _connectivity,
            items: const ['High','Medium','Low']
                .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                .toList(),
            onChanged: (v) => setState(() => _connectivity = v ?? 'High'),
            decoration: const InputDecoration(labelText: 'Connectivity'),
          ),
        ],
      ),
      actions: [
        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
        FilledButton(
          onPressed: () {
            if (_feature.text.trim().isEmpty) return;
            gs.features.add(HabitatFeature(
              feature: _feature.text.trim(),
              condition: _condition,
              connectivity: _connectivity,
            ));
            gs.notifyListeners();
            Navigator.pop(context);
          },
          child: const Text('Add'),
        ),
      ],
    );
  }
}

/// ====== STEP 4: THREATS ======
class ThreatsScreen extends StatefulWidget { const ThreatsScreen({super.key}); @override State<ThreatsScreen> createState() => _ThreatsScreenState(); }
class _ThreatsScreenState extends State<ThreatsScreen> {
  final _threat = TextEditingController();
  String _likelihood = 'Medium';
  String _impact = 'Medium';
  final _mitigation = TextEditingController();

  @override
  void dispose() { _threat.dispose(); _mitigation.dispose(); super.dispose(); }

  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Threats & Mitigation')),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          showDialog(context: context, builder: (_) => _addThreatDialog(gs));
        },
        label: const Text('Add'),
        icon: const Icon(Icons.add),
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: gs.threats.length,
        itemBuilder: (_, i) {
          final t = gs.threats[i];
          return Card(
            child: ListTile(
              title: Text(t.threat),
              subtitle: Text('Likelihood: ${t.likelihood} • Impact: ${t.impact}\nMitigation: ${t.mitigation}'),
              trailing: IconButton(
                icon: const Icon(Icons.delete),
                onPressed: () { gs.threats.removeAt(i); gs.notifyListeners(); },
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _addThreatDialog(GameState gs) {
    return AlertDialog(
      title: const Text('Add Threat'),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(controller: _threat, decoration: const InputDecoration(labelText: 'Threat (e.g., road construction)')),
            DropdownButtonFormField<String>(
              value: _likelihood,
              items: const ['Low','Medium','High']
                  .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                  .toList(),
              onChanged: (v) => setState(() => _likelihood = v ?? 'Medium'),
              decoration: const InputDecoration(labelText: 'Likelihood'),
            ),
            DropdownButtonFormField<String>(
              value: _impact,
              items: const ['Low','Medium','High']
                  .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                  .toList(),
              onChanged: (v) => setState(() => _impact = v ?? 'Medium'),
              decoration: const InputDecoration(labelText: 'Impact'),
            ),
            TextField(controller: _mitigation, decoration: const InputDecoration(labelText: 'Mitigation')),          
          ],
        ),
      ),
      actions: [
        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
        FilledButton(
          onPressed: () {
            if (_threat.text.trim().isEmpty) return;
            gs.threats.add(ThreatRecord(
              threat: _threat.text.trim(),
              likelihood: _likelihood,
              impact: _impact,
              mitigation: _mitigation.text.trim(),
            ));
            gs.notifyListeners();
            Navigator.pop(context);
          },
          child: const Text('Add'),
        ),
      ],
    );
  }
}

/// ====== STEP 5: MONITORING ======
class MonitoringScreen extends StatefulWidget { const MonitoringScreen({super.key}); @override State<MonitoringScreen> createState() => _MonitoringScreenState(); }
class _MonitoringScreenState extends State<MonitoringScreen> {
  final _indicator = TextEditingController();
  final _method = TextEditingController();
  String _frequency = 'Quarterly';
  final _responsible = TextEditingController();

  @override
  void dispose() { _indicator.dispose(); _method.dispose(); _responsible.dispose(); super.dispose(); }

  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Monitoring Plan')),
      floatingActionButton: FloatingActionButton.extended(
        onPressed: () {
          showDialog(context: context, builder: (_) => _addMonitoringDialog(gs));
        },
        label: const Text('Add'),
        icon: const Icon(Icons.add),
      ),
      body: ListView.builder(
        padding: const EdgeInsets.all(16),
        itemCount: gs.monitoring.length,
        itemBuilder: (_, i) {
          final m = gs.monitoring[i];
          return Card(
            child: ListTile(
              title: Text(m.indicator),
              subtitle: Text('Method: ${m.method}\nFreq: ${m.frequency} • Resp: ${m.responsible}'),
              trailing: IconButton(
                icon: const Icon(Icons.delete),
                onPressed: () { gs.monitoring.removeAt(i); gs.notifyListeners(); },
              ),
            ),
          );
        },
      ),
    );
  }

  Widget _addMonitoringDialog(GameState gs) {
    return AlertDialog(
      title: const Text('Add Monitoring Action'),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            TextField(controller: _indicator, decoration: const InputDecoration(labelText: 'Indicator (e.g., nesting pairs)')),
            TextField(controller: _method, decoration: const InputDecoration(labelText: 'Method (e.g., monthly transects)')),
            DropdownButtonFormField<String>(
              value: _frequency,
              items: const ['Monthly','Quarterly','Biannual','Annual']
                  .map((e) => DropdownMenuItem(value: e, child: Text(e)))
                  .toList(),
              onChanged: (v) => setState(() => _frequency = v ?? 'Quarterly'),
              decoration: const InputDecoration(labelText: 'Frequency'),
            ),
            TextField(controller: _responsible, decoration: const InputDecoration(labelText: 'Responsible (role/org)')),
          ],
        ),
      ),
      actions: [
        TextButton(onPressed: () => Navigator.pop(context), child: const Text('Cancel')),
        FilledButton(
          onPressed: () {
            if (_indicator.text.trim().isEmpty) return;
            gs.monitoring.add(MonitoringAction(
              indicator: _indicator.text.trim(),
              method: _method.text.trim(),
              frequency: _frequency,
              responsible: _responsible.text.trim(),
            ));
            gs.notifyListeners();
            Navigator.pop(context);
          },
          child: const Text('Add'),
        ),
      ],
    );
  }
}

/// ====== GENERATE PDF ======
class GenerateScreen extends StatelessWidget {
  const GenerateScreen({super.key});

  Future<Uint8List> _buildPdf(GameState gs) async {
    final doc = pw.Document();
    final dateStr = DateFormat('yyyy-MM-dd').format(DateTime.now());

    pw.Widget sectionTitle(String t) => pw.Padding(
      padding: const pw.EdgeInsets.only(top: 8, bottom: 4),
      child: pw.Text(t, style: pw.TextStyle(fontSize: 16, fontWeight: pw.FontWeight.bold)),
    );

    doc.addPage(
      pw.MultiPage(
        pageFormat: PdfPageFormat.a4,
        build: (context) => [
          pw.Text('Critical Habitat Assessment (CHA) Plan',
              style: pw.TextStyle(fontSize: 20, fontWeight: pw.FontWeight.bold)),
          pw.Text('Generated: $dateStr'),
          pw.SizedBox(height: 8),

          sectionTitle('1. Site Information'),
          pw.Bullet(text: 'Country: ${gs.site.country}'),
          pw.Bullet(text: 'Region: ${gs.site.region}'),
          pw.Bullet(text: 'Site: ${gs.site.siteName}'),
          pw.Bullet(text: 'Area: ${gs.site.areaKm2?.toStringAsFixed(2)} km²'),
          pw.Bullet(text: 'Dominant Land Use: ${gs.site.landUse}'),

          sectionTitle('2. Species Inventory'),
          if (gs.species.isEmpty)
            pw.Text('No species recorded.')
          else
            pw.Column(children: gs.species.map((s) =>
              pw.Bullet(text: '${s.commonName} (${s.scientificName}) — IUCN: ${s.iucnStatus} — Trigger: ${s.isCriticalTrigger ? 'Yes' : 'No'}${s.notes.isNotEmpty ? ' — Notes: ${s.notes}' : ''}')
            ).toList()),

          sectionTitle('3. Habitat Features'),
          if (gs.features.isEmpty)
            pw.Text('No features recorded.')
          else
            pw.Column(children: gs.features.map((f) =>
              pw.Bullet(text: '${f.feature} — Condition: ${f.condition} — Connectivity: ${f.connectivity}')
            ).toList()),

          sectionTitle('4. Threats & Mitigation'),
          if (gs.threats.isEmpty)
            pw.Text('No threats recorded.')
          else
            pw.Column(children: gs.threats.map((t) =>
              pw.Bullet(text: '${t.threat} — Likelihood: ${t.likelihood} — Impact: ${t.impact} — Mitigation: ${t.mitigation}')
            ).toList()),

          sectionTitle('5. Monitoring Plan'),
          if (gs.monitoring.isEmpty)
            pw.Text('No monitoring actions recorded.')
          else
            pw.Column(children: gs.monitoring.map((m) =>
              pw.Bullet(text: '${m.indicator} — Method: ${m.method} — Frequency: ${m.frequency} — Responsible: ${m.responsible}')
            ).toList()),

          sectionTitle('6. Determination & Notes'),
          pw.Text('Based on the presence of critical trigger species and habitat condition/connectivity, '\
              'this site ${gs.species.any((s) => s.isCriticalTrigger) ? 'MEETS' : 'does NOT clearly meet'} the criteria for Critical Habitat (IFC PS6).'),
          pw.Text('This is a decision-support output; final determination should be validated by a qualified ecologist.'),
        ],
      ),
    );
    return doc.save();
  }

  @override
  Widget build(BuildContext context) {
    final gs = context.watch<GameState>();
    return Scaffold(
      appBar: AppBar(title: const Text('Generate Plan')),
      body: Padding(
        padding: const EdgeInsets.all(16),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            const Text('Preview & export your Critical Habitat Assessment (CHA) Plan.'),
            const SizedBox(height: 12),
            Expanded(
              child: PdfPreview(
                canChangePageFormat: false,
                canChangeOrientation: false,
                build: (format) => _buildPdf(gs),
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

---

## Android config (optional)
Ensure `android/app/build.gradle` has:
```gradle
android {
    defaultConfig {
        minSdkVersion 21
        targetSdkVersion 34
    }
}
```

Add internet permission (for PDF preview fonts/downloads if needed):
```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest ...>
  <uses-permission android:name="android.permission.INTERNET"/>
  <application ...>
    <!-- existing -->
  </application>
</manifest>
```

---

## QA Checklist
- [x] All forms validate required fields
- [x] No null crashes; defensive checks in PDF
- [x] Buttons disabled until prerequisites complete
- [x] Single-file architecture for easy transfer
- [x] PDF export tested with `printing` preview

---

## Next Enhancements (nice-to-have)
- Local persistence (e.g., `shared_preferences` or `hive`)
- Multi-language (EN/FR/AR/Bn/Vi/Ur/Hi)
- Map widget & simple GIS overlay (e.g., `google_maps_flutter`)
- Role-based templates (Academic, Consultant, NGO)
- Theming for organizers (UNESCO, BarcelonaReAct, UOC, USAL, URJC)
